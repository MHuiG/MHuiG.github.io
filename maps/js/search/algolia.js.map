{"version":3,"sources":["js/search/algolia.js"],"names":["_defineProperty","obj","key","value","Object","defineProperty","enumerable","configurable","writable","SearchService","search","algolia","fn","template","init","div","document","createElement","innerHTML","body","append","volantis","GLOBAL_CONFIG","appId","apiKey","indexName","event","setAlgolia","querySelector","style","textAlign","maxHeight","addEventListener","close","querySelectorAll","forEach","e","onSubmit","_volantis$dark","instantsearch","searchClient","algoliasearch","searchFunction","helper","state","query","configure","widgets","hitsPerPage","searchBox","container","autofocus","showReset","showSubmit","showLoadingIndicator","searchAsYouType","placeholder","templates","input","hits","item","data","link","permalink","concat","root","path","result","_highlightResult","content","contentStripTruncate","cutContent","contentStrip","title","empty","languages","hits_empty","replace","stats","text","hits_stats","nbHits","processingTimeMS","powerBy","poweredBy","theme","dark","mode","pagination","totalPages","first","last","previous","next","addWidgets","start","window","pjax","on","refresh","getElementById","setQueryText","queryText","_search","setUiState","_search2","display","code","once","preventDefault","target","firstOccur","indexOf","end","pre","post","length","substring","freeze"],"mappings":"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","file":"../../../js/search/algolia.js","sourcesContent":["let SearchService = (() => {\n  const fn = {};\n  let search, algolia;\n\n  fn.template = `<div id=\"u-search\">\n  <div class=\"modal\">\n    <header class=\"modal-header\" class=\"clearfix\">\n      <button type=\"submit\" id=\"u-search-modal-btn-submit\" class=\"u-search-btn-submit\">\n        <span class=\"fa-solid fa-search\"></span>\n      </button>\n      <div id=\"algolia-search-input\"></div>\n      <a id=\"u-search-btn-close\" class=\"btn-close\"> <span class=\"fa-solid fa-times\"></span> </a>\n    </header>\n    <main class=\"modal-body\">\n      <div id=\"algolia-search-results\">\n        <div id=\"algolia-hits\"></div>\n      </div>\n    </main>\n    <footer>\n      <div id=\"algolia-pagination\"></div>\n      <hr>\n      <div id=\"algolia-info\">\n        <div class=\"algolia-stats\"></div>\n        <div class=\"algolia-poweredBy\"></div>\n      </div>\n    </footer>\n  </div>\n  <div id=\"modal-overlay\" class=\"modal-overlay\"></div>\n  </div>\n  `;\n\n  fn.init = () => {\n    let div = document.createElement(\"div\");\n    div.innerHTML += fn.template;\n    document.body.append(div);\n\n    algolia = volantis.GLOBAL_CONFIG.search;\n    if (algolia.appId && algolia.apiKey && algolia.indexName) {\n      fn.event();\n      fn.setAlgolia();\n    } else {\n      document.querySelector('#u-search main.modal-body').innerHTML = 'Algolia setting is invalid!';\n      document.querySelector('#u-search main.modal-body').style.textAlign = 'center';\n      document.querySelector('#u-search .modal').style.maxHeight = '128px';\n    }\n  }\n\n  fn.event = () => {\n    document\n      .querySelector(\"#u-search-btn-close\")\n      .addEventListener(\"click\", fn.close, false);\n    document\n      .querySelector(\"#modal-overlay\")\n      .addEventListener(\"click\", fn.close, false);\n    document.querySelectorAll(\".u-search-form\").forEach((e) => {\n      e.addEventListener(\"submit\", fn.onSubmit, false);\n    });\n\n  }\n\n  fn.setAlgolia = () => {\n    search = instantsearch({\n      indexName: algolia.indexName,\n      searchClient: algoliasearch(algolia.appId, algolia.apiKey),\n      searchFunction(helper) {\n        helper.state.query && helper.search()\n      },\n    })\n\n    const configure = instantsearch.widgets.configure({\n      hitsPerPage: algolia.hitsPerPage\n    })\n\n    const searchBox = instantsearch.widgets.searchBox({\n      container: '#algolia-search-input',\n      autofocus: true,\n      showReset: false,\n      showSubmit: false,\n      showLoadingIndicator: false,\n      searchAsYouType: algolia.searchAsYouType,\n      placeholder: algolia.placeholder,\n      templates: {\n        input: 'algolia-input'\n      }\n    })\n\n    const hits = instantsearch.widgets.hits({\n      container: '#algolia-hits',\n      templates: {\n        item(data) {\n          const link = data.permalink ? data.permalink : `${volantis.GLOBAL_CONFIG.root}${data.path}`\n          const result = data._highlightResult\n          const content = result.contentStripTruncate\n            ? fn.cutContent(result.contentStripTruncate.value)\n            : result.contentStrip\n              ? fn.cutContent(result.contentStrip.value)\n              : result.content\n                ? fn.cutContent(result.content.value)\n                : ''\n          return `\n            <a href=\"${link}\" class=\"result\">\n            <span class=\"title\">${result.title.value || 'no-title'}</span>\n            <span class=\"digest\">${content}</span>\n            </a>`\n        },\n        empty: function (data) {\n          return (\n            `<div id=\"algolia-hits-empty\">${volantis.GLOBAL_CONFIG.languages.algolia.hits_empty.replace(/\\$\\{query}/, data.query)}</div>`\n          )\n        }\n      }\n    })\n\n    const stats = instantsearch.widgets.stats({\n      container: '#algolia-info > .algolia-stats',\n      templates: {\n        text: function (data) {\n          const stats = volantis.GLOBAL_CONFIG.languages.algolia.hits_stats\n            .replace(/\\$\\{hits}/, data.nbHits)\n            .replace(/\\$\\{time}/, data.processingTimeMS)\n          return (\n            `${stats}`\n          )\n        }\n      }\n    })\n\n    const powerBy = instantsearch.widgets.poweredBy({\n      container: '#algolia-info > .algolia-poweredBy',\n      theme: volantis.dark?.mode === 'dark' ? 'dark' : 'light'\n    })\n\n    const pagination = instantsearch.widgets.pagination({\n      container: '#algolia-pagination',\n      totalPages: 5,\n      templates: {\n        first: '<i class=\"fas fa-angle-double-left\"></i>',\n        last: '<i class=\"fas fa-angle-double-right\"></i>',\n        previous: '<i class=\"fas fa-angle-left\"></i>',\n        next: '<i class=\"fas fa-angle-right\"></i>'\n      }\n    })\n\n    search.addWidgets([configure, searchBox, hits, stats, powerBy, pagination])\n\n    search.start()\n\n    window.pjax && search.on('render', () => {\n      window.pjax.refresh(document.getElementById('algolia-hits'))\n    })\n  }\n\n  fn.setQueryText = queryText => {\n    if (!search) {\n      fn.init()\n    }\n    search?.setUiState({\n      [algolia.indexName]: {\n        query: queryText\n      }\n    })\n  }\n\n  fn.search = () => {\n    search?.refresh();\n    document.querySelector(\"#u-search\").style.display = \"block\";\n    document.addEventListener(\"keydown\", event => {\n      if (event.code === \"Escape\") {\n        fn.close();\n      }\n    }, { once: true })\n  }\n\n  fn.onSubmit = (event) => {\n    event.preventDefault();\n    let input = event.target.querySelector(\".u-search-input\");\n    fn.setQueryText(input?.value ? input.value : event.target.value)\n    fn.search();\n  };\n\n  fn.cutContent = content => {\n    if (content === '') return ''\n\n    const firstOccur = content.indexOf('<mark>')\n\n    let start = firstOccur - 30\n    let end = firstOccur + 120\n    let pre = ''\n    let post = ''\n\n    if (start <= 0) {\n      start = 0\n      end = 140\n    } else {\n      pre = '...'\n    }\n\n    if (end > content.length) {\n      end = content.length\n    } else {\n      post = '...'\n    }\n\n    let matchContent = pre + content.substring(start, end) + post\n    return matchContent\n  }\n\n  fn.close = () => {\n    document.querySelector(\"#u-search\").style.display = \"none\";\n  };\n\n  return {\n    init: fn.init,\n    setQueryText: queryText => {\n      fn.setQueryText(queryText);\n    },\n    search: fn.search,\n    close: fn.close\n  }\n})()\n\nObject.freeze(SearchService);\n\nSearchService.init();\ndocument.addEventListener(\"pjax:send\", SearchService.close);\n"]}