function requestIssuesAPI(a,r,o){var l=10;!function t(){return new Promise(function(s,e){var n=0,i=setTimeout(function(){0===n&&(n=2,i=null,e("请求超时"),0==l&&o())},5e3);fetch(a).then(function(e){if(2!==n&&(clearTimeout(i),s(e),i=null,n=1),e.ok)return e.json();throw new Error("Network response was not ok.")}).then(function(e){l=0,r(e)}).catch(function(e){0<l?(--l,setTimeout(function(){t()},5e3)):o()})})}()}function parseIssueStrToJson(e){var s=e.match(/```json[\s|\S]*```/);if(s&&0<s.length&&(s=s[0]),s=s&&s.split("```json")[1].split("```")[0])return JSON.parse(s)}function groupIssuesData(e,s){var n=new Object;if(0<s.length)if(null!=e.group){var t=e.group.split(":");if(1<t.length){var a=t[0],r=t[1];for(a&&r&&(r=r.split(",")),e.group=r,i=0;i<s.length;i++){var o=parseIssueStrToJson(s[i].body);if(o&&a in o)for(var l,c=(c=o[a]).replace(", ",",").split(","),p=0;p<c.length;p++)r.includes(c[p])&&(null==(l=n[c[p]])&&(l=new Array),l.push(o),n[c[p]]=l)}}}else for(e.group=[""],i=0;i<s.length;i++){var u,d=parseIssueStrToJson(s[i].body);d&&(null==(u=n[""])&&(u=new Array),u.push(d),n[""]=u)}return n}function getIssuesAPIForSites(s){var c=$(s.el)[0];$(c).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),requestIssuesAPI(s.api,function(e){$(c).find(".loading").remove();var o=groupIssuesData(s,e),l=Object.keys(o);s.group.forEach(function(e,s){var n=o[e];if(n&&0<n.length)for(0<e.length?$(c).append("<h2>"+e+"</h2>"):""==name&&1<l.length&&$(c).append("<h2>未分组</h2>"),$(c).append('<div class="site-card-group '+s+'"></div>'),j=0;j<n.length;j++){var i=n[j],t=i.screenshot&&0<i.screenshot.length?'<div class="img"><img src="'+i.screenshot+'" onerror="javascript:this.src=\'https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/052.jpg\';"/></div>':'<div class="img"></div>',a='<div class="info">';i.avatar&&0<i.avatar.length&&(a+='<img src="'+i.avatar+'" onerror="javascript:this.src=\'https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/052.jpg\';"/>'),a+='<span class="title">'+i.title+'</span><span class="desc">'+i.description+"</span></div>";var r="<a class='site-card' target='_blank' href='"+i.url+"'>"+t+a+"</a>";$(c).find(".site-card-group."+s).append(r)}})},function(){$(c).find(".loading i").remove(),$(c).find(".loading p").text("加载失败，请稍后重试。")})}function getIssuesAPIForTimeline(e){var t=$(e.el)[0];$(t).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),requestIssuesAPI(e.api,function(e){if($(t).find(".loading").remove(),0<e.length)for(i=0;i<e.length;i++){var s='&nbsp;&nbsp;<a class="comments" target="_blank" href="'+e[i].html_url+'"><i class="fa fa-comment-dots fa-fw"></i>'+e[i].comments+"</a>",n='<div class="timenode"><div class="meta"><p></p><p>'+e[i].title+s+'</p><p></p></div><div class="body"><p>'+e[i].body+"</p></div></div>";$(t).append(n)}},function(){$(t).find(".loading i").remove(),$(t).find(".loading p").text("加载失败，请稍后重试。")})}function checkIssues(){for(var e=document.getElementsByClassName("issues-api"),s=0;s<e.length;s++){var n=e[s],i=n.getAttribute("api"),t=n.getAttribute("group"),a=new Object;a.class=n.getAttribute("class"),a.el=n,a.api=i,a.group=t,a.class.split(" ").includes("sites")?getIssuesAPIForSites(a):a.class.split(" ").includes("timeline")&&getIssuesAPIForTimeline(a)}}document.addEventListener("DOMContentLoaded",function(){checkIssues()}),document.addEventListener("pjax:complete",function(){checkIssues()});