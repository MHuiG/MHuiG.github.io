var IssuesAPI={requestIssuesAPI:function(a,r,o){var l=10;!function n(){return new Promise(function(e,s){var i=0,t=setTimeout(function(){0===i&&(i=2,t=null,s("请求超时"),0==l&&o())},5e3);fetch(a).then(function(s){if(2!==i&&(clearTimeout(t),e(s),t=null,i=1),s.ok)return s.json();throw new Error("Network response was not ok.")}).then(function(s){l=0,r(s)}).catch(function(s){0<l?(--l,setTimeout(function(){n()},5e3)):o()})})}()},parseIssueStrToJson:function(s){var e=s.match(/```json[\s|\S]*```/);if(e&&0<e.length&&(e=e[0]),e=e&&e.split("```json")[1].split("```")[0])return JSON.parse(e)},groupIssuesData:function(s,e){var t=new Object;if(0<e.length)if(null!=s.group){var n=s.group.split(":");if(1<n.length){var a=n[0],r=n[1];for(a&&r&&(r=r.split(",")),s.group=r,i=0;i<e.length;i++){var o=this.parseIssueStrToJson(e[i].body);if(o&&a in o)for(var l,p=(p=o[a]).replace(", ",",").split(","),c=0;c<p.length;c++)r.includes(p[c])&&(null==(l=t[p[c]])&&(l=new Array),l.push(o),t[p[c]]=l)}}}else for(s.group=[""],i=0;i<e.length;i++){var u,d=this.parseIssueStrToJson(e[i].body);d&&(null==(u=t[""])&&(u=new Array),u.push(d),t[""]=u)}return t},getIssuesAPIForSites:function(e){var p=$(e.el)[0];$(p).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),this.requestIssuesAPI(e.api,function(s){$(p).find(".loading").remove();var o=IssuesAPI.groupIssuesData(e,s),l=Object.keys(o);e.group.forEach(function(s,e){var i=o[s];if(i&&0<i.length)for(0<s.length?$(p).append("<h2>"+s+"</h2>"):""==name&&1<l.length&&$(p).append("<h2>未分组</h2>"),$(p).append('<div class="site-card-group '+e+'"></div>'),j=0;j<i.length;j++){var t=i[j],n=t.screenshot&&0<t.screenshot.length?'<div class="img"><img src="'+t.screenshot+'" onerror="javascript:this.src=\'https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/052.jpg\';"/></div>':'<div class="img"></div>',a='<div class="info">';t.avatar&&0<t.avatar.length&&(a+='<img src="'+t.avatar+'" onerror="javascript:this.src=\'https://cdn.jsdelivr.net/gh/volantis-x/cdn-wallpaper-minimalist/2020/052.jpg\';"/>'),a+='<span class="title">'+t.title+'</span><span class="desc">'+t.description+"</span></div>";var r="<a class='site-card' target='_blank' href='"+t.url+"'>"+n+a+"</a>";$(p).find(".site-card-group."+e).append(r)}})},function(){$(p).find(".loading i").remove(),$(p).find(".loading p").text("加载失败，请稍后重试。")})},getIssuesAPIForTimeline:function(s){var n=$(s.el)[0];$(n).append('<div class="loading"><i class="fa fa-cog fa-2x fa-spin"></i><p>正在加载</p></div>'),this.requestIssuesAPI(s.api,function(s){if($(n).find(".loading").remove(),0<s.length)for(i=0;i<s.length;i++){var e='&nbsp;&nbsp;<a class="comments" target="_blank" href="'+s[i].html_url+'"><i class="fa fa-comment-dots fa-fw"></i>'+s[i].comments+"</a>",t='<div class="timenode"><div class="meta"><p></p><p>'+s[i].title+e+'</p><p></p></div><div class="body"><p>'+s[i].body+"</p></div></div>";$(n).append(t)}},function(){$(n).find(".loading i").remove(),$(n).find(".loading p").text("加载失败，请稍后重试。")})},request:function(){for(var s=document.getElementsByClassName("issues-api"),e=0;e<s.length;e++){var i=s[e],t=i.getAttribute("api"),n=i.getAttribute("group"),a=new Object;a.class=i.getAttribute("class"),a.el=i,a.api=t,a.group=n,a.class.split(" ").includes("sites")?this.getIssuesAPIForSites(a):a.class.split(" ").includes("timeline")&&this.getIssuesAPIForTimeline(a)}}};IssuesAPI.request(),document.addEventListener("pjax:complete",function(){IssuesAPI.request()});